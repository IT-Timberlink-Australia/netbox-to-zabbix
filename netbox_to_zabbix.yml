---
- name: Sync NetBox Aruba devices to Zabbix
  hosts: all
  gather_facts: false
  vars:
    # API Configuration
    zabbix_api_url: "{{ lookup('env', 'ZABBIX_API_URL') }}"
    zabbix_api_token: "{{ lookup('env', 'ZABBIX_API_TOKEN') }}"
    
    # Device Mapping Configuration
    role_to_template_mapping:
      "network-switch-edge-sw": 
        templateid: "10748"
      "_default":
        templateid: "10564"
    
    site_to_group_mapping:
      "tarpeena": "23"
      "bell_bay": "22"
      "_default": "5"
    
    site_to_proxy_mapping:
      "22": "10633"    # Site ID 22 → Proxy ID 10633
      "23": "10761"    # Site ID 23 → Proxy ID 10761
      "_default": "10084"

  tasks:
    - name: Verify we have inventory data
      debug:
        msg: "Processing device {{ inventory_hostname }} with IP {{ ansible_host }}"
      run_once: true

    - name: Create/update host in Zabbix
      block:
        - name: Validate required fields
          assert:
            that:
              - ansible_host is defined
              - site_id is defined
              - device_roles[0] is defined
            fail_msg: "Missing required fields for {{ inventory_hostname }}"

        - name: Submit to Zabbix API
          uri:
            url: "{{ zabbix_api_url }}"
            method: POST
            headers:
              Content-Type: "application/json"
            body_format: json
            body: |
              {
                "jsonrpc": "2.0",
                "method": "host.create",
                "params": {
                  "host": "{{ inventory_hostname }}",
                  "interfaces": [{
                    "type": 1,
                    "main": 1,
                    "useip": 1,
                    "ip": "{{ ansible_host }}",
                    "dns": "",
                    "port": "10050"
                  }],
                  "groups": [{
                    "groupid": "{{ site_to_group_mapping[site_slug] | default(site_to_group_mapping['_default']) }}"
                  }],
                  "templates": [{
                    "templateid": "{{ role_to_template_mapping[device_roles[0]].templateid | default(role_to_template_mapping['_default'].templateid) }}"
                  }],
                  "proxy_hostid": "{{ site_to_proxy_mapping[site_id | string] | default(site_to_proxy_mapping['_default']) }}"
                },
                "auth": "{{ zabbix_api_token }}",
                "id": 1
              }
            status_code: 200
            validate_certs: no
          delegate_to: localhost
          register: host_creation
          retries: 3
          delay: 5
      
      rescue:
        - name: Log creation error
          debug:
            msg: "Failed to process {{ inventory_hostname }}: {{ ansible_failed_result.msg }}"

    - name: Show sync result
      debug:
        msg: |
          Zabbix Sync Result for {{ inventory_hostname }}:
          Status: {{ 'Success' if host_creation is defined and not host_creation.failed else 'Failed' }}
          Response: {{ host_creation.json | default('No response') }}
      when: host_creation is defined